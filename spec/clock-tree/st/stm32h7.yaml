version: 1.0.0
family: STM32H7
reference_manual:
  id: RM0399
  devices:
  - STM32H745
  - STM32H755
  - STM32H747
  - STM32H757
  revision: Rev.4
  notes:
  - "Clock sources: HSI, CSI (~4 MHz), HSE (4\u201348 MHz), LSE (32.768 kHz), LSI\
    \ (~32 kHz), HSI48 (48 MHz)."
  - 'System clock sources: HSE, HSI, CSI, or PLL1_P via RCC_CFGR.SW.'
  - "PLL ref (after DIVM) 1\u201316 MHz; \u03A3\u0394 fractional supported; VCO ranges\
    \ per VCOSEL."
metadata:
  modeling_goals:
  - Each gate/mux/divider/source appears as a distinct node.
  - Frequency limits live on producing nodes (sources, PLL VCOs, domain/bus outputs).
  - Descriptions paraphrase RM text; device-dependent notes in 'notes'.
signals:
- name: hsi_ck
  kind: source
  frequency:
    notes: Availability depends on device/options; see DS.
    nominal_options_hz:
    - 8000000
    - 16000000
    - 32000000
    - 64000000
  description: High-speed internal RC; can feed SYSCLK and PLL.
- name: csi_ck
  kind: source
  frequency:
    nominal_hz: 4000000
  description: Low-power internal RC (~4 MHz); can feed SYSCLK and PLL.
- name: hse_ck
  kind: source
  frequency:
    min_hz: 4000000
    max_hz: 48000000
  description: "External high-speed crystal/clock (4\u201348 MHz). For external clock,\
    \ set RCC_CR.HSEBYP and drive OSC_IN (bypass)."
- name: lse_ck
  kind: source
  frequency:
    nominal_hz: 32768
  description: Low-speed external 32.768 kHz in backup domain. For bypass mode, use
    RCC_BDCR.LSEBYP.
- name: lsi_ck
  kind: source
  frequency:
    nominal_hz: 32000
    notes: Approximate; see DS for tolerance.
  description: Low-speed internal RC (~32 kHz), for IWDG/RTC as selected.
- name: hsi48_ck
  kind: source
  frequency:
    nominal_hz: 48000000
  description: 48 MHz internal RC (USB and others, device-dependent).
- name: ref1_ck
  kind: derived
  from:
  - PLLSRC_mux
  - DIVM1
  frequency:
    min_hz: 1000000
    max_hz: 16000000
  description: "PLL1 reference after DIVM1 (must be 1\u201316 MHz)."
- name: ref2_ck
  kind: derived
  from:
  - PLLSRC_mux
  - DIVM2
  frequency:
    min_hz: 1000000
    max_hz: 16000000
  description: PLL2 reference after DIVM2.
- name: ref3_ck
  kind: derived
  from:
  - PLLSRC_mux
  - DIVM3
  frequency:
    min_hz: 1000000
    max_hz: 16000000
  description: PLL3 reference after DIVM3.
- name: vco1_ck
  kind: pll_vco
  from:
  - ref1_ck
  frequency:
    notes: "Choose VCOL when ref1_ck \u2264 2 MHz; otherwise VCOH."
    ranges_hz:
    - when: PLL1VCOSEL=VCOH
      min: 192000000
      max: 960000000
    - when: PLL1VCOSEL=VCOL
      min: 150000000
      max: 420000000
  description: "PLL1 VCO (integer/fractional \u03A3\u0394; FRAC update on-the-fly)."
- name: pll1_p_ck
  kind: pll_output
  from:
  - vco1_ck
  - PLL1_DIVP
  description: PLL1 'P' output; can feed SYSCLK.
- name: pll1_q_ck
  kind: pll_output
  from:
  - vco1_ck
  - PLL1_DIVQ
  description: PLL1 'Q' output (kernel clocks).
- name: pll1_r_ck
  kind: pll_output
  from:
  - vco1_ck
  - PLL1_DIVR
  description: PLL1 'R' output (e.g., TRACE).
- name: vco2_ck
  kind: pll_vco
  from:
  - ref2_ck
  frequency:
    ranges_hz:
    - when: PLL2VCOSEL=VCOH
      min: 192000000
      max: 960000000
    - when: PLL2VCOSEL=VCOL
      min: 150000000
      max: 420000000
  description: PLL2 VCO; same constraints as PLL1.
- name: pll2_p_ck
  kind: pll_output
  from:
  - vco2_ck
  - PLL2_DIVP
  description: PLL2 'P' output.
- name: pll2_q_ck
  kind: pll_output
  from:
  - vco2_ck
  - PLL2_DIVQ
  description: PLL2 'Q' output.
- name: pll2_r_ck
  kind: pll_output
  from:
  - vco2_ck
  - PLL2_DIVR
  description: PLL2 'R' output.
- name: vco3_ck
  kind: pll_vco
  from:
  - ref3_ck
  frequency:
    ranges_hz:
    - when: PLL3VCOSEL=VCOH
      min: 192000000
      max: 960000000
    - when: PLL3VCOSEL=VCOL
      min: 150000000
      max: 420000000
  description: PLL3 VCO; same constraints as PLL1/2.
- name: pll3_p_ck
  kind: pll_output
  from:
  - vco3_ck
  - PLL3_DIVP
  description: PLL3 'P' output.
- name: pll3_q_ck
  kind: pll_output
  from:
  - vco3_ck
  - PLL3_DIVQ
  description: PLL3 'Q' output.
- name: pll3_r_ck
  kind: pll_output
  from:
  - vco3_ck
  - PLL3_DIVR
  description: PLL3 'R' output.
- name: sys_ck
  kind: mux_output
  from:
  - hse_ck
  - hsi_ck
  - csi_ck
  - pll1_p_ck
  description: System clock; switch occurs only when target is ready.
- name: d1_cpu_ck
  kind: divided
  from:
  - sys_ck
  description: CPU1 clock (D1 domain).
- name: hclk_bus_matrix
  kind: divided
  from:
  - d1_cpu_ck
  frequency_limit:
    min_hz: 0
    max_hz: 200000000
  description: "AXI/AHB bus matrix clock; \u2264 200 MHz."
- name: pclk3
  kind: divided
  from:
  - hclk_bus_matrix
  description: APB3 bus clock.
- name: pclk1
  kind: divided
  from:
  - hclk_bus_matrix
  description: APB1 bus clock.
- name: pclk2
  kind: divided
  from:
  - hclk_bus_matrix
  description: APB2 bus clock.
- name: mco1_src_ck
  kind: mux_output
  from:
  - hsi_ck
  - lse_ck
  - hse_ck
  - pll1_q_ck
  - hsi48_ck
  description: MCO1 source selection.
- name: mco1_ck
  kind: divided
  from:
  - mco1_src_ck
  description: MCO1 output clock after prescaler.
- name: mco2_src_ck
  kind: mux_output
  from:
  - sys_ck
  - pll2_p_ck
  - hse_ck
  - pll1_p_ck
  - csi_ck
  - lsi_ck
  description: MCO2 source selection.
- name: mco2_ck
  kind: divided
  from:
  - mco2_src_ck
  description: MCO2 output clock after prescaler.
- name: pllsrc_mux_out_ck
  kind: mux_output
  from:
  - PLLSRC_mux
  description: Output of PLLSRC_mux feeding DIVM1/2/3.
sources:
- name: HSI
  output: hsi_ck
  description: Internal high-speed RC.
- name: CSI
  output: csi_ck
  description: Internal ~4 MHz RC.
- name: HSE
  output: hse_ck
  description: "External/crystal 4..48 MHz."
- name: LSE
  output: lse_ck
  description: External 32.768 kHz.
- name: LSI
  output: lsi_ck
  description: Internal ~32 kHz RC.
- name: HSI48
  output: hsi48_ck
  description: Internal 48 MHz RC.
muxes:
- name: PLLSRC_mux
  output: pllsrc_mux_out_ck
  inputs:
  - hsi_ck
  - csi_ck
  - hse_ck
  - ""
  control:
    inputs:
    - hsi_ck
    - csi_ck
    - hse_ck
    - ""
    reg: RCC_PLLCKSELR
    field: PLLSRC
    notes: Set '11' (none) if no PLL is used to save power.
  description: Common PLL source selection feeding DIVM1/2/3.
- name: SYSCLK_mux
  output: sys_ck
  inputs:
  - hsi_ck
  - csi_ck
  - hse_ck
  - pll1_p_ck
  control:
    inputs:
    - hsi_ck
    - csi_ck
    - hse_ck
    - pll1_p_ck
    reg: RCC_CFGR
    field: SW
  description: System clock source selection (status in RCC_CFGR.SWS).
plls:
- name: PLL1
  input: ref1_ck
  output: vco1_ck
  feedback_integer:
    reg: RCC_PLL1DIVR
    field: DIVN
    value_range:
      min: 8
      max: 432
      offset: -1
  feedback_fraction:
    reg: RCC_PLL1FRACR
    field: FRACN
    value_range:
      min: 0
      max: 8191
      scale: 8192
  vco_limits:
    min: 192000000
    max: 960000000
  description: "Main PLL for CPU and high-speed peripherals"  
- name: PLL2
  input: ref2_ck
  output: vco2_ck
  feedback_integer:
    reg: RCC_PLL2DIVR
    field: DIVN
    value_range:
      min: 8
      max: 432
      offset: -1
  feedback_fraction:
    reg: RCC_PLL2FRACR
    field: FRACN
    value_range:
      min: 0
      max: 8191
      scale: 8192
  vco_limits:
    min: 192000000
    max: 960000000
  description: "Dedicated PLL for peripherals"  
- name: PLL3
  input: ref3_ck
  output: vco3_ck
  feedback_integer:
    reg: RCC_PLL3DIVR
    field: DIVN
    value_range:
      min: 8
      max: 432
      offset: -1
  feedback_fraction:
    reg: RCC_PLL3FRACR
    field: FRACN
    value_range:
      min: 0
      max: 8191
      scale: 8192
  vco_limits:
    min: 192000000
    max: 960000000
  description: "Dedicated PLL for peripherals"  
dividers:
- name: DIVM1
  input: pllsrc_mux_out_ck
  output: ref1_ck
  control:
    reg: RCC_PLLCKSELR
    field: DIVM1
    range: '[1..63]'
  description: "PLL1 pre-divider; ensures 1\u201316 MHz at ref1_ck."
- name: DIVM2
  input: pllsrc_mux_out_ck
  output: ref2_ck
  control:
    reg: RCC_PLLCKSELR
    field: DIVM2
    range: '[1..63]'
  description: PLL2 pre-divider.
- name: DIVM3
  input: pllsrc_mux_out_ck
  output: ref3_ck
  control:
    reg: RCC_PLLCKSELR
    field: DIVM3
    range: '[1..63]'
  description: PLL3 pre-divider.
- name: PLL1_DIVP
  input: vco1_ck
  output: pll1_p_ck
  control:
    reg: RCC_PLL1DIVR
    field: PLL1P
    range: '[2..128]'
    notes: Enable with RCC_PLLCFGR.DIVP1EN.
  description: PLL1 P output divider.
- name: PLL1_DIVQ
  input: vco1_ck
  output: pll1_q_ck
  control:
    reg: RCC_PLL1DIVR
    field: PLL1Q
    range: '[2..128]'
    notes: Enable with RCC_PLLCFGR.DIVQ1EN.
  description: PLL1 Q output divider.
- name: PLL1_DIVR
  input: vco1_ck
  output: pll1_r_ck
  control:
    reg: RCC_PLL1DIVR
    field: PLL1R
    range: '[2..128]'
    notes: Enable with RCC_PLLCFGR.DIVR1EN.
  description: PLL1 R output divider.
- name: PLL2_DIVP
  input: vco2_ck
  output: pll2_p_ck
  control:
    reg: RCC_PLL2DIVR
    field: PLL2P
    range: '[2..128]'
    notes: Enable with RCC_PLLCFGR.DIVP2EN.
  description: PLL2 P output divider.
- name: PLL2_DIVQ
  input: vco2_ck
  output: pll2_q_ck
  control:
    reg: RCC_PLL2DIVR
    field: PLL2Q
    range: '[2..128]'
    notes: Enable with RCC_PLLCFGR.DIVQ2EN.
  description: PLL2 Q output divider.
- name: PLL2_DIVR
  input: vco2_ck
  output: pll2_r_ck
  control:
    reg: RCC_PLL2DIVR
    field: PLL2R
    range: '[2..128]'
    notes: Enable with RCC_PLLCFGR.DIVR2EN.
  description: PLL2 R output divider.
- name: PLL3_DIVP
  input: vco3_ck
  output: pll3_p_ck
  control:
    reg: RCC_PLL3DIVR
    field: PLL3P
    range: '[2..128]'
    notes: Enable with RCC_PLLCFGR.DIVP3EN.
  description: PLL3 P output divider.
- name: PLL3_DIVQ
  input: vco3_ck
  output: pll3_q_ck
  control:
    reg: RCC_PLL3DIVR
    field: PLL3Q
    range: '[2..128]'
    notes: Enable with RCC_PLLCFGR.DIVQ3EN.
  description: PLL3 Q output divider.
- name: PLL3_DIVR
  input: vco3_ck
  output: pll3_r_ck
  control:
    reg: RCC_PLL3DIVR
    field: PLL3R
    range: '[2..128]'
    notes: Enable with RCC_PLLCFGR.DIVR3EN.
  description: PLL3 R output divider.
- name: D1CPRE
  input: sys_ck
  output: d1_cpu_ck
  control:
    reg: RCC_D1CFGR
    field: D1CPRE
    factors:
    - 1
    - 2
    - 4
    - 8
    - 16
    - 64
    - 128
    - 256
    - 512
  description: CPU1 prescaler (D1 domain).
- name: HPRE
  input: d1_cpu_ck
  output: hclk_bus_matrix
  control:
    reg: RCC_D1CFGR
    field: HPRE
    factors:
    - 1
    - 2
    - 4
    - 8
    - 16
  description: AXI/AHB bus matrix prescaler.
- name: D1PPRE
  input: hclk_bus_matrix
  output: pclk3
  control:
    reg: RCC_D1CFGR
    field: D1PPRE
    factors:
    - 1
    - 2
    - 4
    - 8
    - 16
  description: APB3 prescaler.
- name: D2PPRE1
  input: hclk_bus_matrix
  output: pclk1
  control:
    reg: RCC_D2CFGR
    field: D2PPRE1
    factors:
    - 1
    - 2
    - 4
    - 8
    - 16
  description: APB1 prescaler.
- name: D2PPRE2
  input: hclk_bus_matrix
  output: pclk2
  control:
    reg: RCC_D2CFGR
    field: D2PPRE2
    factors:
    - 1
    - 2
    - 4
    - 8
    - 16
  description: APB2 prescaler.
- name: MCO1PRE
  input: mco1_src_ck
  output: mco1_ck
  control:
    reg: RCC_CFGR
    field: MCO1PRE
    range: '[1..15]'
  description: MCO1 prescaler.
- name: MCO2PRE
  input: mco2_src_ck
  output: mco2_ck
  control:
    reg: RCC_CFGR
    field: MCO2PRE
    range: '[1..15]'
  description: MCO2 prescaler.
gates:
- name: DMA1EN
  output: dma1_hclk
  input: rcc_hclk1
  control:
    reg: RCC_AHB1ENR
    bit: DMA1EN
  description: DMA1 bus interface clock gate (AHB1).
- name: ADC12EN
  output: adc12_bus_ck
  input: rcc_hclk1
  control:
    reg: RCC_AHB1ENR
    bit: ADC12EN
  description: ADC1/2 bus interface clock gate; ADC kernel clock selected separately.
- name: USB1OTGHSEN
  output: usb1otg_bus_ck
  input: rcc_hclk1
  control:
    reg: RCC_AHB1ENR
    bit: USB1OTGHSEN
  description: USB1 OTG HS peripheral bus clock gate.
- name: ETH1MACEN
  output: eth1mac_bus_ck
  input: rcc_hclk1
  control:
    reg: RCC_AHB1ENR
    bit: ETH1MACEN
  description: Ethernet MAC bus interface clock gate.
- name: ETH1TXEN
  output: eth1tx_ck
  input: rcc_hclk1
  control:
    reg: RCC_AHB1ENR
    bit: ETH1TXEN
  description: Ethernet TX clock gate.
- name: ETH1RXEN
  output: eth1rx_ck
  input: rcc_hclk1
  control:
    reg: RCC_AHB1ENR
    bit: ETH1RXEN
  description: Ethernet RX clock gate.
