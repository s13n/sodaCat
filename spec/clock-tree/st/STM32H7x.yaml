version: "1.0.0"
family: STM32H7
documents:
  - id: RM0399
    title: STM32H745/755/747/757 Reference Manual

devices:
  - STM32H745
  - STM32H755
  - STM32H747
  - STM32H757

sources:
  - name: HSE
    description: External high-speed oscillator
    frequencies: [0, 8000000, 12000000, 16000000]
    control:
      reg: RCC_CR
      field: HSEON
      instance: RCC

  - name: HSI
    description: Internal high-speed oscillator
    frequencies: [64000000]
    control:
      reg: RCC_CR
      field: HSION
      instance: RCC

  - name: CSI
    description: Internal low-speed oscillator
    frequencies: [4000000]
    control:
      reg: RCC_CR
      field: CSION
      instance: RCC

  - name: LSE
    description: External low-speed oscillator
    frequencies: [32768]
    control:
      reg: RCC_BDCR
      field: LSEON
      instance: RCC

  - name: LSI
    description: Internal low-speed oscillator
    frequencies: [32000]
    control:
      reg: RCC_CSR
      field: LSION
      instance: RCC

  - name: HSI48
    description: Internal 48 MHz oscillator for USB and RNG
    frequencies: [48000000]
    control:
      reg: RCC_CR
      field: HSI48ON
      instance: RCC

signals:
  - name: d1_domain_ck
    description: Clock for domain D1

  - name: d2_domain_ck
    description: Clock for domain D2

  - name: d3_domain_ck
    description: Clock for domain D3

  - name: hclk
    description: AHB bus clock

  - name: SYSCLK
    description: System clock
    max: 480000000

  - name: ref1_clk
    description: PLL1 reference input clock

  - name: vco1_ck
    description: PLL1 VCO output
    max: 960000000

  - name: pll1_p_in
    description: Input to PLL1 DIVP

  - name: pll1_q_in
    description: Input to PLL1 DIVQ

  - name: pll1_r_in
    description: Input to PLL1 DIVR

  - name: pll1_p_ck
    description: PLL1 DIVP output

  - name: pll1_q_ck
    description: PLL1 DIVQ output

  - name: pll1_r_ck
    description: PLL1 DIVR output

  - name: ahb1_ck
    description: AHB1 bus clock

  - name: ahb2_ck
    description: AHB2 bus clock

  - name: ahb3_ck
    description: AHB3 bus clock

  - name: ahb4_ck
    description: AHB4 bus clock

  - name: apb1_ck
    description: APB1 low-speed peripheral clock

  - name: apb2_ck
    description: APB2 high-speed peripheral clock

  - name: apb3_ck
    description: APB3 peripheral clock

  - name: apb4_ck
    description: APB4 peripheral clock

  - name: SYSCLK
    description: System clock
    max: 480000000

  - name: ref1_clk
    description: PLL1 reference input clock

  - name: ref2_clk
    description: PLL2 reference input clock

  - name: ref3_clk
    description: PLL3 reference input clock

  - name: vco1_ck
    description: PLL1 VCO output
    max: 960000000

  - name: vco2_ck
    description: PLL2 VCO output
    max: 960000000

  - name: vco3_ck
    description: PLL3 VCO output
    max: 960000000

  - name: pll1_p_in
    description: Input to PLL1 DIVP

  - name: pll1_q_in
    description: Input to PLL1 DIVQ

  - name: pll1_r_in
    description: Input to PLL1 DIVR

  - name: pll2_p_in
    description: Input to PLL2 DIVP

  - name: pll2_q_in
    description: Input to PLL2 DIVQ

  - name: pll2_r_in
    description: Input to PLL2 DIVR

  - name: pll3_p_in
    description: Input to PLL3 DIVP

  - name: pll3_q_in
    description: Input to PLL3 DIVQ

  - name: pll3_r_in
    description: Input to PLL3 DIVR

  - name: pll1_p_ck
    description: PLL1 DIVP output

  - name: pll1_q_ck
    description: PLL1 DIVQ output

  - name: pll1_r_ck
    description: PLL1 DIVR output

  - name: pll2_p_ck
    description: PLL2 DIVP output

  - name: pll2_q_ck
    description: PLL2 DIVQ output

  - name: pll2_r_ck
    description: PLL2 DIVR output

  - name: pll3_p_ck
    description: PLL3 DIVP output

  - name: pll3_q_ck
    description: PLL3 DIVQ output

  - name: pll3_r_ck
    description: PLL3 DIVR output

  - name: d1_domain_ck
    description: Clock for domain D1

  - name: d2_domain_ck
    description: Clock for domain D2

  - name: d3_domain_ck
    description: Clock for domain D3

  - name: hclk
    description: AHB bus clock

  - name: ahb1_ck
    description: AHB1 bus clock

  - name: ahb2_ck
    description: AHB2 bus clock

  - name: ahb3_ck
    description: AHB3 bus clock

  - name: ahb4_ck
    description: AHB4 bus clock

  - name: apb1_ck
    description: APB1 low-speed peripheral clock

  - name: apb2_ck
    description: APB2 high-speed peripheral clock

  - name: apb3_ck
    description: APB3 peripheral clock

  - name: apb4_ck
    description: APB4 peripheral clock

  - name: tim1_ck
    description: TIM1 peripheral clock

  - name: tim2_ck
    description: TIM2 peripheral clock

  - name: adc1_ck
    description: ADC1 peripheral clock

  - name: spi1_ck
    description: SPI1 peripheral clock

  - name: i2c1_ck
    description: I2C1 peripheral clock

  - name: usart1_ck
    description: USART1 peripheral clock

  - name: spi1_kernel_ck
    description: SPI1 kernel clock

  - name: i2c1_kernel_ck
    description: I2C1 kernel clock

  - name: usart1_kernel_ck
    description: USART1 kernel clock

  - name: adc_kernel_ck
    description: ADC kernel clock

muxes:
  - name: D1_DOMAIN_MUX
    description: Selects clock source for D1 domain
    control:
      reg: RCC_D1CFGR
      field: D1CPRE
      instance: RCC
    inputs: [SYSCLK]
    output: d1_domain_ck

  - name: D2_DOMAIN_MUX
    description: Selects clock source for D2 domain
    control:
      reg: RCC_D2CFGR
      field: D2CPRE
      instance: RCC
    inputs: [d1_domain_ck]
    output: d2_domain_ck

  - name: D3_DOMAIN_MUX
    description: Selects clock source for D3 domain
    control:
      reg: RCC_D3CFGR
      field: D3CPRE
      instance: RCC
    inputs: [d1_domain_ck]
    output: d3_domain_ck

  - name: SYSCLK_MUX
    description: System clock source selector
    control:
      reg: RCC_CFGR
      field: SW
      instance: RCC
    inputs: [HSI, CSI, HSE, vco1_ck]
    output: SYSCLK

  - name: SPI1_KERNEL_MUX
    description: Selects kernel clock source for SPI1
    control:
      reg: RCC_D2CCIP1R
      field: SPI123SEL
      instance: RCC
    inputs: [pll1_q_ck, pll2_p_ck, pll3_p_ck, HSI]
    output: spi1_kernel_ck

  - name: I2C1_KERNEL_MUX
    description: Selects kernel clock source for I2C1
    control:
      reg: RCC_D2CCIP2R
      field: I2C123SEL
      instance: RCC
    inputs: [HSI, pll3_r_ck]
    output: i2c1_kernel_ck

  - name: USART1_KERNEL_MUX
    description: Selects kernel clock source for USART1
    control:
      reg: RCC_D2CCIP2R
      field: USART16SEL
      instance: RCC
    inputs: [pll2_q_ck, pll3_q_ck, HSI, SYSCLK]
    output: usart1_kernel_ck

  - name: ADC_KERNEL_MUX
    description: Selects kernel clock source for ADCs
    control:
      reg: RCC_D3CCIPR
      field: ADCSEL
      instance: RCC
    inputs: [pll2_p_ck, pll3_p_ck]
    output: adc_kernel_ck

plls:
  - name: PLL1
    input: ref1_clk
    output: vco1_ck
    feedback_integer:
      reg: RCC_PLL1DIVR
      field: DIVN1
      instance: RCC
      value_range: [4, 512]
      offset: 0
      scale: 1
    feedback_fraction:
      reg: RCC_PLL1FRACR
      field: FRACN1
      instance: RCC
      value_range: [0, 8191]
      offset: 0
      scale: 1
    vco_limits:
      min: 192000000
      max: 960000000

  - name: PLL2
    input: ref2_clk
    output: vco2_ck
    feedback_integer:
      reg: RCC_PLL2DIVR
      field: DIVN2
      instance: RCC
      value_range: [4, 512]
      offset: 0
      scale: 1
    feedback_fraction:
      reg: RCC_PLL2FRACR
      field: FRACN2
      instance: RCC
      value_range: [0, 8191]
      offset: 0
      scale: 1
    vco_limits:
      min: 192000000
      max: 960000000

  - name: PLL3
    input: ref3_clk
    output: vco3_ck
    feedback_integer:
      reg: RCC_PLL3DIVR
      field: DIVN3
      instance: RCC
      value_range: [4, 512]
      offset: 0
      scale: 1
    feedback_fraction:
      reg: RCC_PLL3FRACR
      field: FRACN3
      instance: RCC
      value_range: [0, 8191]
      offset: 0
      scale: 1
    vco_limits:
      min: 192000000
      max: 960000000

gates:
  - name: PLL1_DIVP_GATE
    description: Enables output of PLL1 DIVP
    input: vco1_ck
    output: pll1_p_in
    control:
      reg: RCC_PLLCFGR
      field: DIVP1EN
      instance: RCC

  - name: PLL1_DIVQ_GATE
    description: Enables output of PLL1 DIVQ
    input: vco1_ck
    output: pll1_q_in
    control:
      reg: RCC_PLLCFGR
      field: DIVQ1EN
      instance: RCC

  - name: PLL1_DIVR_GATE
    description: Enables output of PLL1 DIVR
    input: vco1_ck
    output: pll1_r_in
    control:
      reg: RCC_PLLCFGR
      field: DIVR1EN
      instance: RCC

  - name: PLL2_DIVP_GATE
    input: vco2_ck
    output: pll2_p_in
    control:
      reg: RCC_PLLCFGR
      field: DIVP2EN
      instance: RCC

  - name: PLL2_DIVQ_GATE
    input: vco2_ck
    output: pll2_q_in
    control:
      reg: RCC_PLLCFGR
      field: DIVQ2EN
      instance: RCC

  - name: PLL2_DIVR_GATE
    input: vco2_ck
    output: pll2_r_in
    control:
      reg: RCC_PLLCFGR
      field: DIVR2EN
      instance: RCC

  - name: PLL3_DIVP_GATE
    input: vco3_ck
    output: pll3_p_in
    control:
      reg: RCC_PLLCFGR
      field: DIVP3EN
      instance: RCC

  - name: PLL3_DIVQ_GATE
    input: vco3_ck
    output: pll3_q_in
    control:
      reg: RCC_PLLCFGR
      field: DIVQ3EN
      instance: RCC

  - name: PLL3_DIVR_GATE
    input: vco3_ck
    output: pll3_r_in
    control:
      reg: RCC_PLLCFGR
      field: DIVR3EN
      instance: RCC

  - name: TIM1_GATE
    description: Enables clock for TIM1
    input: apb2_ck
    output: tim1_ck
    control:
      reg: RCC_APB2ENR
      field: TIM1EN
      instance: RCC

  - name: TIM2_GATE
    description: Enables clock for TIM2
    input: apb1_ck
    output: tim2_ck
    control:
      reg: RCC_APB1LENR
      field: TIM2EN
      instance: RCC

  - name: ADC1_GATE
    description: Enables clock for ADC1
    input: ahb1_ck
    output: adc1_ck
    control:
      reg: RCC_AHB1ENR
      field: ADC12EN
      instance: RCC

  - name: SPI1_GATE
    description: Enables clock for SPI1
    input: apb2_ck
    output: spi1_ck
    control:
      reg: RCC_APB2ENR
      field: SPI1EN
      instance: RCC

  - name: I2C1_GATE
    description: Enables clock for I2C1
    input: apb1_ck
    output: i2c1_ck
    control:
      reg: RCC_APB1LENR
      field: I2C1EN
      instance: RCC

  - name: USART1_GATE
    description: Enables clock for USART1
    input: apb2_ck
    output: usart1_ck
    control:
      reg: RCC_APB2ENR
      field: USART1EN
      instance: RCC
      
dividers:
  - name: HCLK_DIV
    description: Divider from SYSCLK to HCLK
    input: SYSCLK
    output: hclk
    control:
      reg: RCC_D1CFGR
      field: HPRE
      instance: RCC
      offset: 0

  - name: PLL1_DIVP
    description: PLL1 output divider P
    input: pll1_p_in
    output: pll1_p_ck
    control:
      reg: RCC_PLL1DIVR
      field: DIVP1
      instance: RCC
      offset: 1

  - name: PLL1_DIVQ
    description: PLL1 output divider Q
    input: pll1_q_in
    output: pll1_q_ck
    control:
      reg: RCC_PLL1DIVR
      field: DIVQ1
      instance: RCC
      offset: 1

  - name: PLL1_DIVR
    description: PLL1 output divider R
    input: pll1_r_in
    output: pll1_r_ck
    control:
      reg: RCC_PLL1DIVR
      field: DIVR1
      instance: RCC
      offset: 1

  - name: PLL2_DIVP
    input: pll2_p_in
    output: pll2_p_ck
    control:
      reg: RCC_PLL2DIVR
      field: DIVP2
      instance: RCC
      offset: 1

  - name: PLL2_DIVQ
    input: pll2_q_in
    output: pll2_q_ck
    control:
      reg: RCC_PLL2DIVR
      field: DIVQ2
      instance: RCC
      offset: 1

  - name: PLL2_DIVR
    input: pll2_r_in
    output: pll2_r_ck
    control:
      reg: RCC_PLL2DIVR
      field: DIVR2
      instance: RCC
      offset: 1

  - name: PLL3_DIVP
    input: pll3_p_in
    output: pll3_p_ck
    control:
      reg: RCC_PLL3DIVR
      field: DIVP3
      instance: RCC
      offset: 1

  - name: PLL3_DIVQ
    input: pll3_q_in
    output: pll3_q_ck
    control:
      reg: RCC_PLL3DIVR
      field: DIVQ3
      instance: RCC
      offset: 1

  - name: PLL3_DIVR
    input: pll3_r_in
    output: pll3_r_ck
    control:
      reg: RCC_PLL3DIVR
      field: DIVR3
      instance: RCC
      offset: 1

  - name: AHB1_DIV
    input: d1_domain_ck
    output: ahb1_ck
    control:
      reg: RCC_D1CFGR
      field: HPRE
      instance: RCC
      offset: 0

  - name: AHB2_DIV
    input: d2_domain_ck
    output: ahb2_ck
    control:
      reg: RCC_D2CFGR
      field: HPRE
      instance: RCC
      offset: 0

  - name: AHB3_DIV
    input: d2_domain_ck
    output: ahb3_ck
    control:
      reg: RCC_D2CFGR
      field: HPRE
      instance: RCC
      offset: 0

  - name: AHB4_DIV
    input: d3_domain_ck
    output: ahb4_ck
    control:
      reg: RCC_D3CFGR
      field: HPRE
      instance: RCC
      offset: 0

  - name: APB1_DIV
    input: d2_domain_ck
    output: apb1_ck
    control:
      reg: RCC_D2CFGR
      field: D2PPRE1
      instance: RCC
      offset: 0

  - name: APB2_DIV
    input: d2_domain_ck
    output: apb2_ck
    control:
      reg: RCC_D2CFGR
      field: D2PPRE2
      instance: RCC
      offset: 0

  - name: APB3_DIV
    input: d1_domain_ck
    output: apb3_ck
    control:
      reg: RCC_D1CFGR
      field: D1PPRE
      instance: RCC
      offset: 0

  - name: APB4_DIV
    input: d3_domain_ck
    output: apb4_ck
    control:
      reg: RCC_D3CFGR
      field: D3PPRE
      instance: RCC
      offset: 0
