family: STM32H7
reference_manual:
  id: RM0399
  devices: [STM32H745, STM32H755, STM32H747, STM32H757]
  revision: Rev.4

signals:
  - name: hsi_ck
    kind: source
    frequency: { nominal_options_mhz: [8,16,32,64] }
    control:
      enable: { reg: RCC_CR, bit: HSION }
      ready_flag: { reg: RCC_CR, bit: HSIRDY }
    description: "High-speed internal RC oscillator."

  - name: csi_ck
    kind: source
    frequency: { nominal_mhz: 4 }
    control:
      enable: { reg: RCC_CR, bit: CSION }
      ready_flag: { reg: RCC_CR, bit: CSIRDY }
    description: "Low-power internal oscillator (~4 MHz)."

  - name: hse_ck
    kind: source
    frequency: { min_mhz: 4, max_mhz: 48 }
    control:
      enable: { reg: RCC_CR, bit: HSEON }
      bypass: { reg: RCC_CR, bit: HSEBYP, mode: "bypass via OSC_IN" }
      ready_flag: { reg: RCC_CR, bit: HSERDY }
    description: "External HSE crystal/clock (4–48 MHz)."

  - name: ref1_ck
    kind: derived
    from: [PLLSRC_mux, DIVM1]
    frequency: { min_mhz: 1, max_mhz: 16 }
    description: "PLL1 reference after DIVM1."

  - name: vco1_ck
    kind: pll_vco
    from: ref1_ck
    frequency:
      ranges_mhz:
        - { when: "VCOSEL=VCOH", min: 192, max: 960 }
        - { when: "VCOSEL=VCOL", min: 150, max: 420 }
      notes: "Select VCOL if ref ≤ 2 MHz; VCOH otherwise."
    description: "PLL1 VCO (ΣΔ fractional supported)."

  - name: pll1_p_ck
    kind: pll_output
    from: [vco1_ck, DIVP1]
    description: "PLL1 P output (can feed SYSCLK)."

  - name: sys_ck
    kind: mux_output
    from: [hse_ck, hsi_ck, csi_ck, pll1_p_ck]
    control:
      mux:
        reg: RCC_CFGR
        field: SW
        encoding: { "00": hsi_ck, "01": csi_ck, "10": hse_ck, "11": pll1_p_ck }
      status: { reg: RCC_CFGR, field: SWS }
    description: "System clock source."

  - name: d1_cpu_ck
    kind: divided
    from: sys_ck
    control:
      divider: { reg: RCC_D1CFGR, field: D1CPRE, factors: [1,2,4,8,16,64,128,256,512] }
    description: "CPU1 clock."

  - name: hclk_bus_matrix
    kind: divided
    from: d1_cpu_ck
    control:
      divider: { reg: RCC_D1CFGR, field: HPRE, factors: [1,2,4,8,16] }
    frequency_limit:
      max_mhz: 200
    description: "AXI/AHB bus matrix (≤ 200 MHz)."

sources:
  - name: HSI
    outputs: [hsi_ck]
    description: "Internal high-speed RC."
  - name: CSI
    outputs: [csi_ck]
    description: "Internal 4 MHz RC."
  - name: HSE
    outputs: [hse_ck]
    description: "External/crystal 4–48 MHz."

muxes:
  - id: PLLSRC_mux
    inputs: [hsi_ck, csi_ck, hse_ck, none]
    output_to: [ref1_ck]
    control:
      reg: RCC_PLLCKSELR
      field: PLLSRC
      encoding: { "00": hsi_ck, "01": csi_ck, "10": hse_ck, "11": none }
    description: "Common PLL source mux."

dividers:
  - id: DIVM1
    input: PLLSRC_mux
    output: ref1_ck
    control: { reg: RCC_PLLCKSELR, field: DIVM1, range: "[1..63]" }
    description: "PLL1 pre-divider."

  - id: PLL1_DIVN_PQR
    input: ref1_ck
    outputs:
      - { name: vco1_ck, kind: vco }
      - { name: pll1_p_ck, from: vco1_ck }
    control:
      vco:
        reg: RCC_PLLCFGR
        fields:
          - { name: PLL1VCOSEL }
          - { name: PLL1RGE }
          - { name: PLL1FRACEN }
      n_divider: { reg: RCC_PLL1DIVR, field: PLL1N, range: "[4..512]" }
      p_divider: { reg: RCC_PLL1DIVR, field: PLL1P, range: "[2..128]" }
      output_enables:
        reg: RCC_PLLCFGR
        fields:
          - { name: DIVP1EN, enables: pll1_p_ck }
    description: "PLL1 configuration (N/P + FRAC)."

gates:
  - id: DMA1EN
    clock: dma1_bus_ck
    control: { reg: RCC_AHB1ENR, bit: DMA1EN }
    description: "DMA1 AHB1 gate."

kernel_clock_examples:
  - peripheral: SDMMC1
    kernel_clock:
      selector:
        reg: SDMMC_CLKCR
        field: SELCLKRX
        encoding:
          "00": sdmmc_io_in_ck
          "01": SDMMC_CKIN_feedback
          "10": sdmmc_fb_ck
      notes: "Identification mode: set SDMMC_CK < 400 kHz via CLKDIV."

constraints_and_rules:
  - "PLL ref (refx_ck) must be 1–16 MHz; choose VCOL if ref ≤ 2 MHz, VCOH otherwise."
  - "Bus matrix (AXI/AHB) ≤ 200 MHz."

text_snippets:
  - id: pll_features
    text: "Independent PLLs with ΣΔ fractional outputs; three P/Q/R dividers with enables."
``